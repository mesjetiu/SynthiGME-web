var st=class{constructor(t={}){let{outputChannels:e=8}=t;this.audioCtx=null,this.modules=[],this.isRunning=!1,this.muted=!1,this.masterBaseGain=1,this.outputChannels=e,this.outputLevels=Array.from({length:this.outputChannels},()=>1),this.outputPans=Array.from({length:this.outputChannels},()=>0),this.outputBuses=[],this.bus1=null,this.bus2=null,this.bus1Mod=null,this.bus2Mod=null,this.bus1L=null,this.bus1R=null,this.bus2L=null,this.bus2R=null,this.masterL=null,this.masterR=null,this.merger=null,this.bus1Level=this.outputLevels[0]||1,this.bus1Pan=this.outputPans[0]||0,this.bus2Level=this.outputLevels[1]||1,this.bus2Pan=this.outputPans[1]||0}start(){if(this.audioCtx){this.audioCtx.state==="suspended"&&this.audioCtx.resume();return}let t=new(window.AudioContext||window.webkitAudioContext);this.audioCtx=t,this.masterL=t.createGain(),this.masterR=t.createGain(),this.masterL.gain.value=this.muted?0:this.masterBaseGain,this.masterR.gain.value=this.muted?0:this.masterBaseGain,this.outputBuses=[];for(let e=0;e<this.outputChannels;e+=1){let n=t.createGain();n.gain.value=1;let o=t.createGain();o.gain.value=this.outputLevels[e],n.connect(o);let s=t.createGain(),i=t.createGain();o.connect(s),o.connect(i),s.connect(this.masterL),i.connect(this.masterR),this.outputBuses.push({input:n,levelNode:o,panLeft:s,panRight:i})}this.bus1=this.outputBuses[0]?.input||null,this.bus2=this.outputBuses[1]?.input||null,this.bus1Mod=this.outputBuses[0]?.levelNode||null,this.bus2Mod=this.outputBuses[1]?.levelNode||null,this.bus1L=this.outputBuses[0]?.panLeft||null,this.bus1R=this.outputBuses[0]?.panRight||null,this.bus2L=this.outputBuses[1]?.panLeft||null,this.bus2R=this.outputBuses[1]?.panRight||null,this.merger=t.createChannelMerger(2),this.masterL.connect(this.merger,0,0),this.masterR.connect(this.merger,0,1),this.merger.connect(t.destination);for(let e of this.modules)e.start&&e.start();for(let e=0;e<this.outputChannels;e+=1)this.updateOutputPan(e);this.isRunning=!0}updateOutputPan(t){let e=this.audioCtx,n=this.outputBuses[t];if(!e||!n)return;let o=this.outputPans[t]??0,s=n.panLeft.gain,i=n.panRight.gain,r=(o+1)*.25*Math.PI,d=Math.cos(r),a=Math.sin(r),c=e.currentTime;s.cancelScheduledValues(c),i.cancelScheduledValues(c),s.setTargetAtTime(d,c,.03),i.setTargetAtTime(a,c,.03)}setOutputLevel(t,e){if(t<0||t>=this.outputChannels)return;this.outputLevels[t]=e;let n=this.audioCtx,o=this.outputBuses[t];if(n&&o){let s=n.currentTime;o.levelNode.gain.cancelScheduledValues(s),o.levelNode.gain.setTargetAtTime(e,s,.03)}t===0&&(this.bus1Level=e),t===1&&(this.bus2Level=e)}getOutputLevel(t){return this.outputLevels[t]??1}setOutputPan(t,e){t<0||t>=this.outputChannels||(this.outputPans[t]=e,this.updateOutputPan(t),t===0&&(this.bus1Pan=e),t===1&&(this.bus2Pan=e))}getOutputBusNode(t){return this.outputBuses[t]?.input||null}connectNodeToOutput(t,e){let n=this.getOutputBusNode(t);return!n||!e?null:(e.connect(n),n)}setBusLevel(t,e){let n=t-1;this.setOutputLevel(n,e)}setBusPan(t,e){let n=t-1;this.setOutputPan(n,e)}addModule(t){this.modules.push(t)}findModule(t){return this.modules.find(e=>e.id===t)||null}setMute(t){if(this.muted=t,!this.audioCtx||!this.masterL||!this.masterR)return;let e=this.audioCtx.currentTime,n=this.muted?0:this.masterBaseGain;this.masterL.gain.cancelScheduledValues(e),this.masterR.gain.cancelScheduledValues(e),this.masterL.gain.setTargetAtTime(n,e,.03),this.masterR.gain.setTargetAtTime(n,e,.03)}toggleMute(){this.setMute(!this.muted)}},S=class{constructor(t,e,n){this.engine=t,this.id=e,this.name=n,this.inputs=[],this.outputs=[]}getAudioCtx(){return this.engine.audioCtx}};var it=class{constructor(t,e,n,o,s={}){this.engine=t,this.tableEl=e,this.sourcePorts=n,this.destPorts=o,this.connections=[],this.options=Object.assign({freqDepth:80,ampDepth:.5,outputGain:1},s)}build(){this.tableEl.innerHTML="";let t=document.createElement("thead"),e=document.createElement("tr"),n=document.createElement("th");n.textContent="Sources \\ Destinos",e.appendChild(n);for(let s of this.destPorts){let i=document.createElement("th"),r=document.createElement("span");r.className="matrix-header-vertical",r.textContent=s.label,i.appendChild(r),e.appendChild(i)}t.appendChild(e),this.tableEl.appendChild(t);let o=document.createElement("tbody");this.connections=[],this.sourcePorts.forEach((s,i)=>{this.connections[i]=[];let r=document.createElement("tr"),d=document.createElement("th");d.textContent=s.label,r.appendChild(d),this.destPorts.forEach((a,c)=>{this.connections[i][c]=null;let u=document.createElement("td"),p=document.createElement("button");p.className="pin-btn",p.dataset.row=i,p.dataset.col=c,p.addEventListener("click",()=>this.toggleConnection(p,i,c)),u.appendChild(p),r.appendChild(u)}),o.appendChild(r)}),this.tableEl.appendChild(o)}getPortNode(t,e){if(!t||!t.moduleId)return null;let n=this.engine.findModule(t.moduleId);if(!n)return null;if(e){let s=n.outputs.find(i=>i.id===t.portId);return s?s.node:null}return n.inputs.find(s=>s.id===t.portId)||null}toggleConnection(t,e,n){window._synthApp&&window._synthApp.ensureAudio&&window._synthApp.ensureAudio(),t.classList.contains("active")?(t.classList.remove("active"),this.removeConnection(e,n)):(t.classList.add("active"),this.createConnection(e,n))}createConnection(t,e){let n=this.engine.audioCtx;if(!n)return;let o=this.sourcePorts[t],s=this.destPorts[e];if(s.type==="output"){let a=this.getPortNode(o,!0);if(!a)return;let c=n.createGain();c.gain.value=this.options.outputGain,a.connect(c);let u=s.busIndex!=null?s.busIndex:typeof s.bus=="number"?s.bus-1:null,p=u!=null?this.engine.getOutputBusNode(u):null;p?c.connect(p):this.engine.masterL&&c.connect(this.engine.masterL),this.connections[t][e]=c;return}let i=this.getPortNode(o,!0),r=this.getPortNode(s,!1);if(!i||!r||!r.param)return;let d=n.createGain();s.type==="freq"&&(d.gain.value=this.options.freqDepth),s.type==="amp"&&(d.gain.value=this.options.ampDepth),i.connect(d),d.connect(r.param),this.connections[t][e]=d}removeConnection(t,e){let n=this.connections[t][e];if(n){try{n.disconnect()}catch{}this.connections[t][e]=null}}};var k=class{constructor(t,e){this.rootEl=t,this.innerEl=t.querySelector(".knob-inner"),this.valueEl=e.valueElement||null,this.min=e.min,this.max=e.max,this.value=e.initial,this.onChange=e.onChange||null,this.format=e.format||(n=>n),this.pixelsForFullRange=e.pixelsForFullRange||150,this.dragging=!1,this.startY=0,this.startValue=this.value,this.minAngle=-135,this.maxAngle=135,this._attach(),this._updateVisual()}_attach(){this.rootEl.addEventListener("pointerdown",e=>{e.pointerType==="touch"&&window.__synthNavGestureActive||(window._synthApp&&window._synthApp.ensureAudio&&window._synthApp.ensureAudio(),this.dragging=!0,this.startY=e.clientY,this.startValue=this.value,this.rootEl.setPointerCapture(e.pointerId))}),this.rootEl.addEventListener("pointermove",e=>{if(!this.dragging||e.pointerType==="touch"&&window.__synthNavGestureActive)return;let n=this.startY-e.clientY,o=(this.max-this.min)/this.pixelsForFullRange;this.setValue(this.startValue+n*o)});let t=e=>{if(this.dragging){this.dragging=!1;try{this.rootEl.releasePointerCapture(e.pointerId)}catch{}}};this.rootEl.addEventListener("pointerup",t),this.rootEl.addEventListener("pointercancel",t),this.rootEl.addEventListener("pointerleave",t)}_updateVisual(){let t=(this.value-this.min)/(this.max-this.min),e=this.minAngle+t*(this.maxAngle-this.minAngle);this.innerEl.style.transform=`rotate(${e}deg)`,this.valueEl&&(this.valueEl.textContent=this.format(this.value))}setValue(t){this.value=Math.min(this.max,Math.max(this.min,t)),this._updateVisual(),this.onChange&&this.onChange(this.value)}getValue(){return this.value}};var K=class extends S{constructor(t,e,n){super(t,e,"Osc "+e),this.baseFreq=n,this.osc=null,this.amp=null}_initAudioNodes(){let t=this.getAudioCtx();!t||this.osc||(this.osc=t.createOscillator(),this.osc.type="sine",this.osc.frequency.value=this.baseFreq,this.amp=t.createGain(),this.amp.gain.value=.4,this.osc.connect(this.amp),this.outputs.push({id:"audioOut",kind:"audio",node:this.amp,label:this.name+" OUT"}),this.inputs.push({id:"freqCV",kind:"cv",param:this.osc.frequency,label:this.name+" FREQ"}),this.inputs.push({id:"ampCV",kind:"cv",param:this.amp.gain,label:this.name+" AMP"}))}start(){this._initAudioNodes();let t=this.getAudioCtx().currentTime+.05;try{this.osc.start(t)}catch{}}stop(t){if(this.osc)try{this.osc.stop(t)}catch{}}createPanel(t){let e=document.createElement("div");e.className="voice-block";let n=document.createElement("div");n.className="voice-title",n.textContent=this.name+" (sine)",e.appendChild(n);let o=document.createElement("div");o.className="knob-row";let s=document.createElement("div");s.className="knob-wrapper";let i=document.createElement("div");i.className="knob";let r=document.createElement("div");r.className="knob-inner",i.appendChild(r);let d=document.createElement("div");d.className="knob-label",d.textContent="Freq";let a=document.createElement("div");a.className="knob-value",s.appendChild(i),s.appendChild(d),s.appendChild(a),o.appendChild(s);let c=document.createElement("div");c.className="knob-wrapper";let u=document.createElement("div");u.className="knob";let p=document.createElement("div");p.className="knob-inner",u.appendChild(p);let m=document.createElement("div");m.className="knob-label",m.textContent="Level";let g=document.createElement("div");g.className="knob-value",c.appendChild(u),c.appendChild(m),c.appendChild(g),o.appendChild(c),e.appendChild(o),t.appendChild(e),new k(i,{min:0,max:1e4,initial:this.baseFreq,pixelsForFullRange:800,valueElement:a,format:v=>v.toFixed(1)+" Hz",onChange:v=>{if(this.osc&&this.osc.frequency){let f=this.getAudioCtx().currentTime;this.osc.frequency.cancelScheduledValues(f),this.osc.frequency.setTargetAtTime(v,f,.03)}}}),new k(u,{min:0,max:1,initial:.4,valueElement:g,format:v=>v.toFixed(2),onChange:v=>{if(this.amp&&this.amp.gain){let f=this.getAudioCtx().currentTime;this.amp.gain.cancelScheduledValues(f),this.amp.gain.setTargetAtTime(v,f,.03)}}})}};var ot=class extends S{constructor(t,e,n){super(t,e,"Pulso "+e),this.baseFreq=n,this.osc=null,this.amp=null,this.pw=.5}_createPulseWave(t,e=32){let n=this.getAudioCtx(),o=Math.min(.99,Math.max(.01,t)),s=new Float32Array(e+1),i=new Float32Array(e+1);for(let r=1;r<=e;r++)i[r]=2/(r*Math.PI)*Math.sin(r*Math.PI*o);return n.createPeriodicWave(s,i)}_updatePulseWave(t){if(!this.osc)return;let e=this._createPulseWave(t);this.osc.setPeriodicWave(e),this.pw=t}_initAudioNodes(){let t=this.getAudioCtx();!t||this.osc||(this.osc=t.createOscillator(),this.osc.frequency.value=this.baseFreq,this.amp=t.createGain(),this.amp.gain.value=.4,this.osc.connect(this.amp),this._updatePulseWave(this.pw),this.outputs.push({id:"audioOut",kind:"audio",node:this.amp,label:this.name+" OUT"}),this.inputs.push({id:"freqCV",kind:"cv",param:this.osc.frequency,label:this.name+" FREQ"}),this.inputs.push({id:"ampCV",kind:"cv",param:this.amp.gain,label:this.name+" AMP"}))}start(){this._initAudioNodes();let t=this.getAudioCtx().currentTime+.05;try{this.osc.start(t)}catch{}}stop(t){if(this.osc)try{this.osc.stop(t)}catch{}}createPanel(t){let e=document.createElement("div");e.className="voice-block";let n=document.createElement("div");n.className="voice-title",n.textContent=this.name+" (pulse)",e.appendChild(n);let o=document.createElement("div");o.className="knob-row";let s=a=>{let c=document.createElement("div");c.className="knob-wrapper";let u=document.createElement("div");u.className="knob";let p=document.createElement("div");p.className="knob-inner",u.appendChild(p);let m=document.createElement("div");m.className="knob-label",m.textContent=a;let g=document.createElement("div");return g.className="knob-value",c.appendChild(u),c.appendChild(m),c.appendChild(g),o.appendChild(c),{knob:u,val:g}},i=s("Freq"),r=s("Level"),d=s("PW");e.appendChild(o),t.appendChild(e),new k(i.knob,{min:0,max:1e4,initial:this.baseFreq,pixelsForFullRange:800,valueElement:i.val,format:a=>a.toFixed(1)+" Hz",onChange:a=>{if(this.osc&&this.osc.frequency){let u=this.getAudioCtx().currentTime;this.osc.frequency.cancelScheduledValues(u),this.osc.frequency.setTargetAtTime(a,u,.03)}}}),new k(r.knob,{min:0,max:1,initial:.4,valueElement:r.val,format:a=>a.toFixed(2),onChange:a=>{if(this.amp&&this.amp.gain){let u=this.getAudioCtx().currentTime;this.amp.gain.cancelScheduledValues(u),this.amp.gain.setTargetAtTime(a,u,.03)}}}),new k(d.knob,{min:.05,max:.95,initial:this.pw,valueElement:d.val,format:a=>Math.round(a*100)+"%",onChange:a=>{this.pw=a,this._updatePulseWave(a)}})}};var at=class extends S{constructor(t,e){super(t,e,"Noise Gen"),this.buffer=null,this.source=null,this.filter=null,this.amp=null,this.colour=.5}_createNoiseBuffer(){let t=this.getAudioCtx();if(!t)return null;let e=t.sampleRate*2,n=t.createBuffer(1,e,t.sampleRate),o=n.getChannelData(0);for(let s=0;s<e;s++)o[s]=Math.random()*2-1;return n}_updateColourParam(t){if(!this.filter)return;let e=this.getAudioCtx();if(!e)return;let n=200,s=n*Math.pow(8e3/n,t),i=e.currentTime;this.filter.frequency.cancelScheduledValues(i),this.filter.frequency.setTargetAtTime(s,i,.05)}_initAudioNodes(){let t=this.getAudioCtx();!t||this.source||(this.buffer=this._createNoiseBuffer(),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.filter=t.createBiquadFilter(),this.filter.type="lowpass",this.amp=t.createGain(),this.amp.gain.value=0,this.source.connect(this.filter),this.filter.connect(this.amp),this.outputs.push({id:"audioOut",kind:"audio",node:this.amp,label:"Noise OUT"}),this._updateColourParam(this.colour))}start(){this._initAudioNodes();let e=this.getAudioCtx().currentTime+.05;try{this.source.start(e)}catch{}}stop(t){if(this.source)try{this.source.stop(t)}catch{}}createPanel(t){let e=document.createElement("div");e.className="voice-block";let n=document.createElement("div");n.className="voice-title",n.textContent="Noise Gen",e.appendChild(n);let o=document.createElement("div");o.className="knob-row";let s=a=>{let c=document.createElement("div");c.className="knob-wrapper";let u=document.createElement("div");u.className="knob";let p=document.createElement("div");p.className="knob-inner",u.appendChild(p);let m=document.createElement("div");m.className="knob-label",m.textContent=a;let g=document.createElement("div");return g.className="knob-value",c.appendChild(u),c.appendChild(m),c.appendChild(g),o.appendChild(c),{knob:u,val:g}},i=s("Colour"),r=s("Level");e.appendChild(o),t.appendChild(e);let d=a=>a<.33?"Low":a>.66?"High":"White";new k(i.knob,{min:0,max:1,initial:this.colour,valueElement:i.val,format:d,pixelsForFullRange:200,onChange:a=>{this.colour=a,this._updateColourParam(a)}}),new k(r.knob,{min:0,max:1,initial:0,valueElement:r.val,format:a=>a.toFixed(2),pixelsForFullRange:200,onChange:a=>{if(this.amp&&this.amp.gain){let u=this.getAudioCtx().currentTime;this.amp.gain.cancelScheduledValues(u),this.amp.gain.setTargetAtTime(a,u,.03)}}})}};var lt=class extends S{constructor(t,e){super(t,e,"Stick"),this.xConst=null,this.yConst=null,this.xGain=null,this.yGain=null,this.x=0,this.y=0}_initAudioNodes(){let t=this.getAudioCtx();!t||this.xConst||(this.xConst=t.createConstantSource(),this.yConst=t.createConstantSource(),this.xConst.offset.value=0,this.yConst.offset.value=0,this.xGain=t.createGain(),this.yGain=t.createGain(),this.xConst.connect(this.xGain),this.yConst.connect(this.yGain),this.outputs.push({id:"xOut",kind:"cv",node:this.xGain,label:"Stick X"}),this.outputs.push({id:"yOut",kind:"cv",node:this.yGain,label:"Stick Y"}))}start(){this._initAudioNodes();let e=this.getAudioCtx().currentTime+.05;try{this.xConst.start(e)}catch{}try{this.yConst.start(e)}catch{}}stop(t){if(!(!this.xConst||!this.yConst)){try{this.xConst.stop(t)}catch{}try{this.yConst.stop(t)}catch{}}}setPosition(t,e){let n=this.getAudioCtx();if(!n||!this.xConst||!this.yConst)return;let o=Math.max(-1,Math.min(1,t)),s=Math.max(-1,Math.min(1,e));this.x=o,this.y=s;let i=n.currentTime;this.xConst.offset.cancelScheduledValues(i),this.yConst.offset.cancelScheduledValues(i),this.xConst.offset.setTargetAtTime(o,i,.03),this.yConst.offset.setTargetAtTime(s,i,.03)}createPanel(t){let e=document.createElement("div");e.className="joystick-block";let n=document.createElement("div");n.className="voice-title",n.textContent="Stick",e.appendChild(n);let o=document.createElement("div");o.className="joystick-pad";let s=document.createElement("div");s.className="joystick-handle",o.appendChild(s),e.appendChild(o);let i=document.createElement("div");i.style.display="flex",i.style.justifyContent="space-between",i.style.fontSize="0.75rem",i.style.marginTop="0.2rem";let r=document.createElement("span"),d=document.createElement("span");r.textContent="X: 0.00",d.textContent="Y: 0.00",i.appendChild(r),i.appendChild(d),e.appendChild(i),t.appendChild(e);let a=(u,p)=>{let m=(u+1)/2,g=(1-p)/2;s.style.left=m*100+"%",s.style.top=g*100+"%",s.style.transform="translate(-50%, -50%)",r.textContent="X: "+u.toFixed(2),d.textContent="Y: "+p.toFixed(2)},c=u=>{let p=o.getBoundingClientRect(),m=(u.clientX-p.left)/p.width,g=(u.clientY-p.top)/p.height,v=Math.max(-1,Math.min(1,m*2-1)),E=Math.max(-1,Math.min(1,1-g*2));this.setPosition(v,E),a(v,E)};o.addEventListener("pointerdown",u=>{u.pointerType==="touch"&&window.__synthNavGestureActive||(window._synthApp&&window._synthApp.ensureAudio&&window._synthApp.ensureAudio(),o.setPointerCapture(u.pointerId),c(u))}),o.addEventListener("pointermove",u=>{u.pointerType==="touch"&&window.__synthNavGestureActive||u.buttons!==0&&c(u)}),o.addEventListener("pointerup",u=>{try{o.releasePointerCapture(u.pointerId)}catch{}}),o.addEventListener("pointerleave",u=>{if(u.buttons!==0)try{o.releasePointerCapture(u.pointerId)}catch{}}),a(0,0)}};var rt=class extends S{constructor(t,e){super(t,e,"Output Router")}start(){let t=this.engine;!t.audioCtx||!t.bus1Mod||!t.bus2Mod||this.inputs.length>0||(this.inputs.push({id:"bus1LevelCV",kind:"cv",param:t.bus1Mod.gain,label:"Output Ch Level 1"}),this.inputs.push({id:"bus2LevelCV",kind:"cv",param:t.bus2Mod.gain,label:"Output Ch Level 2"}))}};function Ot(h,t){let e=document.createElement("div");e.className="voice-block";let n=document.createElement("div");n.className="voice-title",n.textContent="Output Router (Ch1/Ch2 \u2192 L/R)",e.appendChild(n);let o=document.createElement("div");o.className="knob-row";let s=(i,r,d,a,c,u,p=200)=>{let m=document.createElement("div");m.className="knob-wrapper";let g=document.createElement("div");g.className="knob";let v=document.createElement("div");v.className="knob-inner",g.appendChild(v);let E=document.createElement("div");E.className="knob-label",E.textContent=i;let f=document.createElement("div");f.className="knob-value",m.appendChild(g),m.appendChild(E),m.appendChild(f),o.appendChild(m),new k(g,{min:r,max:d,initial:a,valueElement:f,format:c,onChange:u,pixelsForFullRange:p})};s("Ch1 Level",0,1,h.bus1Level,i=>i.toFixed(2),i=>h.setBusLevel(1,i)),s("Ch1 Pan",-1,1,h.bus1Pan,i=>(i<0?"L ":"R ")+Math.abs(i).toFixed(2),i=>h.setBusPan(1,i)),s("Ch2 Level",0,1,h.bus2Level,i=>i.toFixed(2),i=>h.setBusLevel(2,i)),s("Ch2 Pan",-1,1,h.bus2Pan,i=>(i<0?"L ":"R ")+Math.abs(i).toFixed(2),i=>h.setBusPan(2,i)),e.appendChild(o),t.appendChild(e)}var xt=class{constructor(t={}){let{id:e,title:n,subtitle:o}=t;this.id=e||`panel-${Date.now()}`,this.element=document.createElement("div"),this.element.className="panel",this.element.id=this.id,this.sections=new Map;let s=document.createElement("span");s.className="panel-build-version",s.textContent="",this.element.appendChild(s),n&&this.setTitle(n),o&&this.setSubtitle(o)}appendElement(t){return this.element.appendChild(t),t}setTitle(t){return this.titleEl||(this.titleEl=document.createElement("h1"),this.element.appendChild(this.titleEl)),this.titleEl.textContent=t,this.titleEl}setSubtitle(t){return this.subtitleEl||(this.subtitleEl=document.createElement("p"),this.subtitleEl.style.fontSize="0.8rem",this.subtitleEl.style.textAlign="center",this.subtitleEl.style.marginTop="0",this.element.appendChild(this.subtitleEl)),this.subtitleEl.textContent=t,this.subtitleEl}addHeaderElement(t){return t?(this.element.insertBefore(t,this.titleEl||this.element.firstChild),t):null}addSection({id:t,title:e,type:n="row",className:o}={}){if(!t)throw new Error("Section id is required");if(e){let i=document.createElement("div");i.className="section-title",i.textContent=e,this.element.appendChild(i)}let s;if(n==="matrix"){let i=document.createElement("div");i.className="matrix-container";let r=document.createElement("table");r.className="matrix",i.appendChild(r),this.element.appendChild(i),s=r}else if(n==="custom")s=document.createElement("div"),o&&(s.className=o),this.element.appendChild(s);else{let i=document.createElement("div");i.className=o||"row",this.element.appendChild(i),s=i}return s.id=t,this.sections.set(t,s),s}getSection(t){return this.sections.get(t)||null}},ct=class{constructor(t){if(!t)throw new Error("PanelManager requires a root element");this.rootEl=t,this.panels=new Map}createPanel(t={}){let e=new xt(t);return this.rootEl.appendChild(e.element),t.id&&this.panels.set(t.id,e),e}getPanel(t){return this.panels.get(t)||null}};var ut=class extends S{constructor(t,e="outputFaders"){super(t,e,"Output Faders")}createPanel(t){if(!t)return;let e=document.createElement("div");e.className="voice-block output-fader-panel";let n=document.createElement("div");n.className="voice-title",n.textContent="Buses de salida",e.appendChild(n);let o=document.createElement("div");o.className="output-fader-row";let s=this.engine.outputChannels||0;for(let i=0;i<s;i+=1){let r=document.createElement("div");r.className="output-fader-column";let d=document.createElement("div");d.className="output-fader-label",d.textContent=`Out ${i+1}`,r.appendChild(d);let a=document.createElement("div");a.className="output-fader-shell";let c=document.createElement("input");c.type="range",c.min="0",c.max="1",c.step="0.01",c.value=String(this.engine.getOutputLevel(i)??1),c.className="output-fader",c.setAttribute("aria-label",`Nivel salida ${i+1}`),c.dataset.preventPan="true";let u=Number(c.value);c.addEventListener("pointerdown",m=>{m.pointerType==="touch"&&window.__synthNavGestureActive||window._synthApp&&window._synthApp.ensureAudio&&window._synthApp.ensureAudio()}),c.addEventListener("input",()=>{if(window.__synthNavGestureActive){c.value=String(u);return}let m=Number(c.value);u=m,this.engine.setOutputLevel(i,m),p.textContent=m.toFixed(2)});let p=document.createElement("div");p.className="output-fader-value",p.textContent=Number(c.value).toFixed(2),a.appendChild(c),r.appendChild(a),r.appendChild(p),o.appendChild(r)}e.appendChild(o),t.appendChild(e)}};var Z=class{constructor(t,{rows:e=63,cols:n=67,frame:o=null}={}){this.table=t,this.rows=e,this.cols=n,this._layoutRaf=null,this._built=!1,this._onTableClick=null,this.frame=this._normalizeFrame(o),this.table&&(this.table.classList.add("matrix-large"),this._applyMatrixStyling(),this._applyLayoutOffsets())}_normalizeFrame(t){let e={squarePercent:90,translateSteps:{x:0,y:0},marginsSteps:{left:0,right:0,top:0,bottom:0},clip:!0,overflowPercent:{left:25,right:60,top:25,bottom:60},maxSizePercent:100};if(!t)return e;let n=typeof t.clip=="boolean"?t.clip:e.clip,o={left:typeof t.overflowPercent?.left=="number"?t.overflowPercent.left:e.overflowPercent.left,right:typeof t.overflowPercent?.right=="number"?t.overflowPercent.right:e.overflowPercent.right,top:typeof t.overflowPercent?.top=="number"?t.overflowPercent.top:e.overflowPercent.top,bottom:typeof t.overflowPercent?.bottom=="number"?t.overflowPercent.bottom:e.overflowPercent.bottom},s=typeof t.maxSizePercent=="number"?t.maxSizePercent:n?e.maxSizePercent:300;return{squarePercent:typeof t.squarePercent=="number"?t.squarePercent:e.squarePercent,translateSteps:{x:typeof t.translateSteps?.x=="number"?t.translateSteps.x:e.translateSteps.x,y:typeof t.translateSteps?.y=="number"?t.translateSteps.y:e.translateSteps.y},marginsSteps:{left:typeof t.marginsSteps?.left=="number"?t.marginsSteps.left:e.marginsSteps.left,right:typeof t.marginsSteps?.right=="number"?t.marginsSteps.right:e.marginsSteps.right,top:typeof t.marginsSteps?.top=="number"?t.marginsSteps.top:e.marginsSteps.top,bottom:typeof t.marginsSteps?.bottom=="number"?t.marginsSteps.bottom:e.marginsSteps.bottom},clip:n,overflowPercent:o,maxSizePercent:s}}_applyMatrixStyling(){if(!this.table)return;let t=7,e=12;this.table.style.setProperty("--matrix-large-pin-size",`${t}px`),this.table.style.setProperty("--matrix-large-cell-size",`${e}px`),this.table.style.background="transparent"}_applyLayoutOffsets(){let t=this.table.closest(".matrix-container");if(!t)return;let e=this.frame.squarePercent,n=(100-e)/2,o=this.cols,s=e/o,i=this.frame.marginsSteps,r=this.frame.translateSteps,d=n+(r.x+i.left)*s,a=n+(r.y+i.top)*s,c=e-(i.left+i.right)*s,u=e-(i.top+i.bottom)*s,p=typeof this.frame.maxSizePercent=="number"?this.frame.maxSizePercent:100;c=Math.max(1,Math.min(p,c)),u=Math.max(1,Math.min(p,u));let m=this.frame.overflowPercent||{left:25,top:25,right:60,bottom:60},g=-Math.abs(m.left||0),v=-Math.abs(m.top||0),E=100-c+Math.abs(m.right||0),f=100-u+Math.abs(m.bottom||0);d=Math.min(E,Math.max(g,d)),a=Math.min(f,Math.max(v,a)),t.style.position="absolute",t.style.left=`${d}%`,t.style.top=`${a}%`,t.style.width=`${c}%`,t.style.height=`${u}%`,t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.overflow=this.frame.clip===!1?"visible":"hidden",t.style.background="transparent",t.dataset.frameLeft=d.toFixed(3),t.dataset.frameTop=a.toFixed(3),t.dataset.frameWidth=c.toFixed(3),t.dataset.frameHeight=u.toFixed(3),t.dataset.frameClip=String(this.frame.clip!==!1)}build(){let t=this.table;if(!t)return;if(this._built){this.resizeToFit();return}t.innerHTML="",this._onTableClick=n=>{let o=n.target?.closest?.("button.pin-btn");!o||!t.contains(o)||o.classList.toggle("active")},t.addEventListener("click",this._onTableClick);let e=document.createElement("tbody");for(let n=0;n<this.rows;n++){let o=document.createElement("tr");for(let s=0;s<this.cols;s++){let i=document.createElement("td"),r=document.createElement("button");r.className="pin-btn",i.appendChild(r),o.appendChild(i)}e.appendChild(o)}t.appendChild(e),this._built=!0,this.resizeToFit()}resizeToFit(){let t=this.table;if(!t)return;let e=t.closest(".matrix-container");e&&(this._layoutRaf&&cancelAnimationFrame(this._layoutRaf),this._layoutRaf=requestAnimationFrame(()=>{this._layoutRaf=null,t.style.transform="none";let n=e.getBoundingClientRect(),o=t.getBoundingClientRect(),s=n.width,i=n.height,r=o.width,d=o.height;if(!s||!i||!r||!d)return;let a=s/r,c=i/d,u=.999,p=Math.min(a,c),m=p<1?p*u:1;t.style.transformOrigin="center center",t.style.transform=`scale(${m})`}))}};var Gt=["Pulse level","Pulse shape","Sine level","Sine symmetry","Triangle level","Sawtooth level","Frequency"],dt=class{constructor(t={}){this.id=t.id||`sgme-osc-${Date.now()}`,this.title=t.title||"Oscillator",this.size=t.size||{width:320,height:90},this.knobGap=t.knobGap||8,this.switchOffset=t.switchOffset||{leftPercent:36,topPx:6},this.knobSize=t.knobSize||42,this.knobInnerPct=t.knobInnerPct||78,this.knobRowOffsetY=t.knobRowOffsetY||-6,this.knobOffsets=t.knobOffsets||[0,0,0,0,0,0,-10],this.knobLabels=t.knobLabels||Gt,this.knobs=[],this.rangeState="hi",this.knobRange=t.knobRange||{min:0,max:1,initial:.4,pixelsForFullRange:150}}createElement(){let t=document.createElement("div");t.className="sgme-osc",t.id=this.id,t.style.setProperty("--osc-width",`${this.size.width}px`),t.style.setProperty("--osc-height",`${this.size.height}px`),t.style.setProperty("--osc-knob-gap",`${this.knobGap}px`),t.style.setProperty("--osc-knob-size",`${this.knobSize}px`),t.style.setProperty("--osc-knob-inner-pct",`${this.knobInnerPct}%`),t.style.setProperty("--osc-knob-row-offset-y",`${this.knobRowOffsetY}px`),t.style.setProperty("--switch-left-percent",`${this.switchOffset.leftPercent}%`),t.style.setProperty("--switch-top-px",`${this.switchOffset.topPx}px`),t.style.width=`${this.size.width}px`,t.style.height=`${this.size.height}px`;let e=document.createElement("div");e.className="sgme-osc__top";let n=document.createElement("div");n.className="sgme-osc__header",n.textContent=this.title,e.appendChild(n);let o=document.createElement("div");o.className="sgme-osc__labels",this.knobLabels.forEach(d=>{let a=document.createElement("span");a.textContent=d,o.appendChild(a)}),e.appendChild(o);let s=document.createElement("div");s.className="sgme-osc__switch",s.innerHTML=`
      <div class="sgme-osc__switch-label">Range</div>
      <div class="sgme-osc__switch-body">
        <span class="sgme-osc__switch-hi">HI</span>
        <span class="sgme-osc__switch-toggle" aria-hidden="true"></span>
        <span class="sgme-osc__switch-lo">LO</span>
      </div>
    `,s.addEventListener("click",()=>{this.rangeState=this.rangeState==="hi"?"lo":"hi",this._renderRange(s)}),e.appendChild(s);let i=document.createElement("div");i.className="sgme-osc__bottom";let r=document.createElement("div");return r.className="sgme-osc__knobs",r.style.transform=`translateY(${this.knobRowOffsetY}px)`,this.knobLabels.forEach((d,a)=>{let c=document.createElement("div");c.className="sgme-osc__knob-shell",Number.isFinite(this.knobOffsets[a])&&(c.style.transform=`translateY(${this.knobOffsets[a]}px)`);let u=document.createElement("div");u.className="knob sgme-osc__knob",u.style.width=`${this.knobSize}px`,u.style.height=`${this.knobSize}px`;let p=document.createElement("div");p.className="knob-inner",p.style.width=`${this.knobInnerPct}%`,p.style.height=`${this.knobInnerPct}%`,u.appendChild(p),c.appendChild(u),r.appendChild(c);let m=new k(u,{min:this.knobRange.min,max:this.knobRange.max,initial:this.knobRange.initial,pixelsForFullRange:this.knobRange.pixelsForFullRange});this.knobs.push(m)}),i.appendChild(r),t.appendChild(e),t.appendChild(i),this._renderRange(s),t}_renderRange(t){let e=this.rangeState==="lo";t.classList.toggle("is-lo",e),t.setAttribute("data-state",e?"lo":"hi")}};var Rt=!1;function Ct(h,t){let e=document.getElementById(h);if(!e||e.querySelector(":scope > .panel-inline-bg"))return;let n=document.createElement("div");n.className="panel-inline-bg",e.insertBefore(n,e.firstChild);let o=document.createElement("object");o.type="image/svg+xml",o.data=t,o.style.cssText="width: 100%; height: 100%; display: block;",o.setAttribute("aria-hidden","true"),n.appendChild(o),e.classList.add("has-inline-bg")}var ht="0.0.1-79";function Tt(h){document.querySelectorAll(".panel-build-version").forEach(e=>{e.textContent=`Versi\xF3n ${h}`})}function Vt(){if(ht&&ht!=="__BUILD_VERSION__"){window.__synthBuildVersion=ht,Tt(ht);return}fetch("../package.json",{cache:"no-store"}).then(h=>h&&h.ok?h.json():null).then(h=>{if(!h||!h.version)return;let t=`${h.version}-src`;window.__synthBuildVersion=t,Tt(t)}).catch(()=>{})}var Et=class{constructor(){this.engine=new st,this.panelManager=new ct(document.getElementById("viewportInner")),this.placeholderPanels={},this.panel1=this.panelManager.createPanel({id:"panel-1"}),this._labelPanelSlot(this.panel1,null,{row:1,col:1}),this.panel2=this.panelManager.createPanel({id:"panel-2"}),this._labelPanelSlot(this.panel2,null,{row:1,col:2}),this.panel3=this.panelManager.createPanel({id:"panel-3"}),this._labelPanelSlot(this.panel3,null,{row:1,col:3}),this._createPlaceholderPanel({id:"panel-4",layout:{row:1,col:4},message:"Espacio libre para los m\xF3dulos del Panel 4 del Synthi original."}),this.panel5=this.panelManager.createPanel({id:"panel-5"}),this._labelPanelSlot(this.panel5,null,{row:2,col:1}),this.panel6=this.panelManager.createPanel({id:"panel-6"}),this._labelPanelSlot(this.panel6,null,{row:2,col:3}),Ct("panel-5","./assets/panels/panel5_bg.svg"),Ct("panel-6","./assets/panels/panel6_bg.svg"),Ct("panel-3","./assets/panels/panel3_bg.svg"),this.outputPanel=this.panelManager.createPanel({id:"panel-output"}),this._labelPanelSlot(this.outputPanel,null,{row:2,col:4}),this.muteBtn=document.createElement("button"),this.muteBtn.id="muteBtn",this.muteBtn.textContent="\u{1F50A} Audio ON",this.panel1.addHeaderElement(this.muteBtn),this.oscRowEl=this.panel1.addSection({id:"oscRow",title:"Oscillators 1\u20133",type:"row"}),this.pulseRowEl=this.panel1.addSection({id:"pulseRow",title:"Oscillator 3 / Pulse",type:"row"}),this.noiseRowEl=this.panel1.addSection({id:"noiseRow",title:"Noise Generator",type:"row"}),this.matrixEl=this.panel2.addSection({id:"matrixTable",type:"matrix"}),this.stickRowEl=this.panel1.addSection({id:"stickRow",title:"Stick (Joystick)",type:"row"}),this.routerRowEl=this.panel1.addSection({id:"routerRow",title:"Output Router (buses \u2192 L/R)",type:"row"}),this.outputFadersRowEl=this.outputPanel.addSection({id:"outputFadersRow",title:"Salidas l\xF3gicas Synthi (1\u20138)",type:"row"}),this.matrix=null,this._heightSyncScheduled=!1,this.largeMatrixAudio=null,this.largeMatrixControl=null,this._buildPanel3Layout(),this._setupModules(),this._buildLargeMatrices(),this._setupUI(),this._schedulePanelSync(),window.addEventListener("resize",()=>{this._schedulePanelSync(),this._resizeLargeMatrices(),this._reflowPanel3Layout()})}ensureAudio(){this.engine.start()}_setupModules(){let t=new K(this.engine,"osc1",110),e=new K(this.engine,"osc2",220),n=new ot(this.engine,"osc3",330),o=new at(this.engine,"noise"),s=new lt(this.engine,"stick"),i=new rt(this.engine,"router"),r=new ut(this.engine,"outputFaders");this.engine.addModule(t),this.engine.addModule(e),this.engine.addModule(n),this.engine.addModule(o),this.engine.addModule(s),this.engine.addModule(i),this.engine.addModule(r),t.createPanel(this.oscRowEl),e.createPanel(this.oscRowEl),n.createPanel(this.pulseRowEl),o.createPanel(this.noiseRowEl),s.createPanel(this.stickRowEl),Ot(this.engine,this.routerRowEl),r.createPanel(this.outputFadersRowEl);let d=[{moduleId:"osc1",portId:"audioOut",label:"Oscillator 1 I"},{moduleId:"osc1",portId:"audioOut",label:"Oscillator 1 II"},{moduleId:"osc2",portId:"audioOut",label:"Oscillator 2 I"},{moduleId:"osc2",portId:"audioOut",label:"Oscillator 2 II"},{moduleId:"osc3",portId:"audioOut",label:"Oscillator 3 I"},{moduleId:"osc3",portId:"audioOut",label:"Oscillator 3 II"},{moduleId:"noise",portId:"audioOut",label:"Noise"},{moduleId:null,portId:null,label:"Input Channel 1"},{moduleId:null,portId:null,label:"Input Channel 2"},{moduleId:null,portId:null,label:"Filter"},{moduleId:null,portId:null,label:"Trapezoid"},{moduleId:null,portId:null,label:"Envelope Signal"},{moduleId:null,portId:null,label:"Ring Modulator"},{moduleId:null,portId:null,label:"Reverberation"},{moduleId:"stick",portId:"xOut",label:"Stick X"},{moduleId:"stick",portId:"yOut",label:"Stick Y"}],a=Array.from({length:this.engine.outputChannels||2},(u,p)=>({moduleId:null,portId:null,type:"output",busIndex:p,label:`Output Ch ${p+1}`})),c=[{moduleId:null,portId:null,type:"amp",label:"Meter"},...a,{moduleId:null,portId:null,type:"amp",label:"Envelope A"},{moduleId:null,portId:null,type:"amp",label:"Envelope B"},{moduleId:null,portId:null,type:"amp",label:"Ring Mod A"},{moduleId:null,portId:null,type:"amp",label:"Ring Mod B"},{moduleId:null,portId:null,type:"amp",label:"Reverb"},{moduleId:"osc1",portId:"freqCV",type:"freq",label:"Osc Freq 1"},{moduleId:"osc2",portId:"freqCV",type:"freq",label:"Osc Freq 2"},{moduleId:"osc3",portId:"freqCV",type:"freq",label:"Osc Freq 3"},{moduleId:null,portId:null,type:"amp",label:"Decay"},{moduleId:null,portId:null,type:"amp",label:"Reverb Mix"},{moduleId:null,portId:null,type:"freq",label:"Filter Freq"},{moduleId:"router",portId:"bus1LevelCV",type:"amp",label:"Output Ch Level 1"},{moduleId:"router",portId:"bus2LevelCV",type:"amp",label:"Output Ch Level 2"}];this.matrix=new it(this.engine,this.matrixEl,d,c,{freqDepth:80,ampDepth:.5,outputGain:1}),this.matrix.build()}_setupUI(){let t=this.muteBtn;t&&t.addEventListener("click",()=>{this.ensureAudio(),this.engine.toggleMute(),t.textContent=this.engine.muted?"\u{1F507} Mute ON":"\u{1F50A} Audio ON",t.classList.toggle("off",this.engine.muted)})}_labelPanelSlot(t,e,n={}){!t||!t.element||(n.row&&(t.element.style.setProperty("--panel-row",n.row),t.element.dataset.panelRow=n.row),n.col&&(t.element.style.setProperty("--panel-col",n.col),t.element.dataset.panelCol=n.col))}_createPlaceholderPanel({id:t,message:e,layout:n}={}){let o=this.panelManager.createPanel({id:t});o.element.classList.add("panel-placeholder"),n&&this._labelPanelSlot(o,null,n);let s=document.createElement("div");return s.className="placeholder-body",s.textContent=e||"Placeholder pendiente de especificaciones.",o.appendElement(s),t&&(this.placeholderPanels[t]=o),o}_getPanel3LayoutSpec(){let t={width:370,height:110};return{oscSize:t,padding:6,gap:{x:0,y:0},airOuter:0,airOuterY:0,rowsPerColumn:6,topOffset:10,knobGap:8,switchOffset:{leftPercent:36,topPx:6},reservedHeight:t.height}}_buildPanel3Layout(){if(!this.panel3)return;let t=document.createElement("div");t.id="panel3Layout",t.className="panel3-layout",this.panel3.appendElement(t);let e=this._getPanel3LayoutSpec(),{oscSize:n,gap:o,rowsPerColumn:s}=e,i=[];for(let a=0;a<s;a+=1)i.push({index:a+1,col:0,row:a});for(let a=0;a<s;a+=1)i.push({index:a+7,col:1,row:a});let r=i.map(a=>{let u=new dt({id:`sgme-osc-${a.index}`,title:`Oscillator ${a.index}`,size:n,knobGap:e.knobGap,switchOffset:e.switchOffset,knobSize:40,knobRowOffsetY:-15,knobInnerPct:76}).createElement();return t.appendChild(u),u}),d=document.createElement("div");d.className="panel3-reserved-row",d.textContent="Reserved strip for future modules",t.appendChild(d),this._panel3LayoutData={host:t,layout:e,oscillatorSlots:i,oscElements:r,reserved:d},this._reflowPanel3Layout()}_reflowPanel3Layout(){let t=this._panel3LayoutData;if(!t)return;let{host:e,layout:n,oscillatorSlots:o,oscElements:s,reserved:i}=t;if(!e||!e.isConnected)return;let{oscSize:r,gap:d,airOuter:a=0,airOuterY:c=-150,topOffset:u,rowsPerColumn:p}=n,m=getComputedStyle(e),g=parseFloat(m.paddingLeft)||0,v=parseFloat(m.paddingRight)||0,E=e.clientWidth,f=r.width,_=f*2+d.x+a*2,z=Math.max(0,(E-_)/2)+a,Q=e.clientHeight,H=p*(r.height+d.y)-d.y,J=H+n.reservedHeight+d.y,T=(Q-c*2-J)/2+c+u;if(o.forEach((G,pt)=>{let I=s[pt];if(!I)return;I.style.width=`${f}px`;let W=z+G.col*(f+d.x),A=T+G.row*(r.height+d.y);I.style.left=`${W}px`,I.style.top=`${A}px`}),i){let G=T+H+d.y;i.style.left=`${g}px`,i.style.right=`${v}px`,i.style.top=`${G}px`,i.style.height=`${n.reservedHeight}px`}}_buildLargeMatrices(){this.panel5MatrixEl=this.panel5.addSection({id:"panel5Matrix",type:"matrix"}),this.panel6MatrixEl=this.panel6.addSection({id:"panel6Matrix",type:"matrix"});let t={moveSteps:{x:5.1,y:0},marginsSteps:{left:-7.47,right:-3,top:4.7,bottom:2.7}},e={squarePercent:90,translateSteps:t.moveSteps,marginsSteps:t.marginsSteps,clip:!0,overflowPercent:{left:25,top:25,right:200,bottom:80},maxSizePercent:300};e.clip===!1?(this.panel5?.element?.classList.add("matrix-adjust"),this.panel6?.element?.classList.add("matrix-adjust")):(this.panel5?.element?.classList.remove("matrix-adjust"),this.panel6?.element?.classList.remove("matrix-adjust")),this.largeMatrixAudio=new Z(this.panel5MatrixEl,{rows:63,cols:67,frame:e}),this.largeMatrixControl=new Z(this.panel6MatrixEl,{rows:63,cols:67,frame:e}),this.largeMatrixAudio.build(),this.largeMatrixControl.build()}_resizeLargeMatrices(){this.largeMatrixAudio&&this.largeMatrixAudio.resizeToFit(),this.largeMatrixControl&&this.largeMatrixControl.resizeToFit()}_schedulePanelSync(){this._heightSyncScheduled||(this._heightSyncScheduled=!0,requestAnimationFrame(()=>{this._heightSyncScheduled=!1,this._syncPanelHeights()}))}_syncPanelHeights(){document.querySelectorAll("#viewportInner .panel").forEach(e=>{e.style.height=""})}};(function(){let h=document.getElementById("viewportOuter"),t=document.getElementById("viewportInner");if(!h||!t)return;window.__synthNavLocks=window.__synthNavLocks||{zoomLocked:!1,panLocked:!1};let e=window.__synthNavLocks,n=1,o=.1,s=6,i=.45,r=.7,d=2e3,a=1200,c="is-low-zoom",u=.35,p=.92,m=32,g=.002,v=.05,E=!1,f=0,_=0,z=!1;function Q(l){let w=window.devicePixelRatio||1,b=(l<.6?24:12)*w;return b?Math.round(l*b)/b:l}let H=new Set;function J(){let l=H.size>=2;window.__synthNavGestureActive=l}let x={contentWidth:0,contentHeight:0,outerWidth:0,outerHeight:0,outerLeft:0,outerTop:0},T=!0,G=(()=>{try{return window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})();function pt(){let l=t.querySelectorAll(".panel");if(!l||l.length===0)return{width:t.scrollWidth,height:t.scrollHeight};let w=0,y=0;return l.forEach(b=>{let C=(b.offsetLeft||0)+(b.offsetWidth||0),L=(b.offsetTop||0)+(b.offsetHeight||0);C>w&&(w=C),L>y&&(y=L)}),{width:w,height:y}}function I(){let l=h.getBoundingClientRect(),w=pt();x.contentWidth=w.width,x.contentHeight=w.height,x.outerWidth=h.clientWidth,x.outerHeight=h.clientHeight,x.outerLeft=l.left,x.outerTop=l.top,T=!1}let W=null;function A(){W||(W=requestAnimationFrame(()=>{W=null,_t()}))}function Ft(){if(E)return;let l=x.contentWidth,w=x.contentHeight;if(!l||!w)return;let y=x.outerWidth,b=x.outerHeight;if(!y||!b)return;let C=l*n,L=w*n;if(G){let M=Math.min(m,C,y),N=Math.min(m,L,b),R=M-C,B=y-M;R<=B?f=Math.min(Math.max(f,R),B):f=(R+B)/2;let q=N-L,j=b-N;q<=j?_=Math.min(Math.max(_,q),j):_=(q+j)/2;return}if(C<=y)f=(y-C)/2;else{let M=y-C;f=Math.min(Math.max(f,M),0)}if(L<=b)_=(b-L)/2;else{let M=b-L;_=Math.min(Math.max(_,M),0)}}let $=!1,Y=null;function Bt(){return $?n<r:n<i}function qt(l){l!==$&&($=l,t.classList.toggle(c,$),$?t.style.willChange="transform":t.style.willChange="")}function tt(l){let w=l==="pinch"?a:d;Y&&(clearTimeout(Y),Y=null),Y=setTimeout(()=>{Y=null,qt(Bt())},w)}function _t(){T&&I(),Ft(),t.style.transform=`translate(${f}px, ${_}px) scale(${n})`}I(),_t();function Lt(){if(!h||!t)return;I();let l=x.contentWidth,w=x.contentHeight;if(!l||!w)return;let y=x.outerWidth,b=x.outerHeight;if(!y||!b)return;let C=y/l,L=b/w,O=Math.min(1,C,L),M=Math.min(s,Math.max(o,O));n=Math.min(s,Math.max(o,Q(M)));let N=l*n,R=w*n,B=(y-N)/2,q=(b-R)/2;f=B,_=q,A()}requestAnimationFrame(()=>Lt());function mt(l){E!==l&&(E=l,A())}function et(){z=!0}window.addEventListener("keydown",l=>{l.key==="Shift"&&mt(!0)}),window.addEventListener("keyup",l=>{l.key==="Shift"&&mt(!1)}),window.addEventListener("blur",()=>{mt(!1)}),h.addEventListener("pointerdown",l=>{l.pointerType==="touch"&&(H.add(l.pointerId),J())},!0);let kt=l=>{l.pointerType==="touch"&&(H.delete(l.pointerId),J())};h.addEventListener("pointerup",kt,!0),h.addEventListener("pointercancel",kt,!0);function zt(l){if(!l)return!1;let w=".knob, .knob-inner, .pin-btn, .joystick-pad, .joystick-handle, .output-fader";return l.closest('[data-prevent-pan="true"]')?!0:!!l.closest(w)}function Pt(l,w,y,{snap:b=!1}={}){let C=(l-f)/n,L=(w-_)/n,O=Math.min(s,Math.max(o,y));n=b?Q(O):O,f=l-C*n,_=w-L*n,A()}h.addEventListener("wheel",l=>{if(T=!0,l.ctrlKey||l.metaKey){l.preventDefault();let L=l.clientX-(x.outerLeft||0),O=l.clientY-(x.outerTop||0),M=l.deltaY<0?1.1:.9,N=Math.min(s,Math.max(o,n*M));Pt(L,O,N),et(),tt("wheel");return}l.preventDefault();let y=l.deltaMode===1?16:l.deltaMode===2?x.outerHeight||h.clientHeight:1,b=l.deltaX*y*u*p,C=l.deltaY*y*u*p;f-=b,_-=C,A(),et()},{passive:!1});let D=!1,F=null,ft=0,gt=0,P=new Map,X=null,V=null,St=!1,bt=null,Mt=0,wt=!1;window.__synthNavGestureActive=!1;function yt(){let l=0;P.forEach(y=>{y&&y.pointerType==="touch"&&(l+=1)}),Mt=l;let w=Mt>=2;w!==wt&&(wt=w,window.__synthNavGestureActive=wt)}h.addEventListener("pointerdown",l=>{P.set(l.pointerId,{x:l.clientX,y:l.clientY,pointerType:l.pointerType}),yt(),(l.pointerType==="mouse"||l.pointerType==="pen")&&P.size===1&&!zt(l.target)&&(D=!0,F=l.pointerId,ft=l.clientX,gt=l.clientY)}),h.addEventListener("pointermove",l=>{if(!P.has(l.pointerId))return;let w=P.get(l.pointerId);if(P.set(l.pointerId,{x:l.clientX,y:l.clientY,pointerType:w?.pointerType}),P.size===2){T=!0,l.preventDefault();let y=Array.from(P.values()),[b,C]=y,L=b.x-C.x,O=b.y-C.y,M=Math.hypot(L,O),N=(b.x+C.x)/2,R=(b.y+C.y)/2,B=N-(x.outerLeft||0),q=R-(x.outerTop||0),j=x.outerWidth||h.clientWidth||0,Ht=x.outerHeight||h.clientHeight||0,Nt=e.panLocked?j/2:B,At=e.panLocked?Ht/2:q;bt={x:Nt,y:At};let It=!1,vt=!1;if(V){let U=N-V.x,nt=R-V.y;e.panLocked||(Math.abs(U)>v||Math.abs(nt)>v)&&(f+=U,_+=nt,It=!0)}if(X!=null){let U=M/X;if(!e.zoomLocked&&Math.abs(U-1)>g){let nt=Math.min(s,Math.max(o,n*U));Pt(Nt,At,nt,{snap:!1}),vt=!0}}X=M,V={x:N,y:R},(vt||It)&&(A(),et(),vt&&tt("pinch")),D=!1,F=null;return}if(P.size===1&&D&&F===l.pointerId){let y=l.clientX-ft,b=l.clientY-gt;ft=l.clientX,gt=l.clientY,f+=y,_+=b,A(),et()}},{passive:!1}),h.addEventListener("pointerup",l=>{P.delete(l.pointerId),yt(),P.size<2&&(X=null,V=null),F===l.pointerId&&(D=!1,F=null),P.size===0&&(St=!1,bt=null,tt("pinch"),A())}),h.addEventListener("pointercancel",l=>{P.delete(l.pointerId),yt(),P.size<2&&(X=null,V=null),F===l.pointerId&&(D=!1,F=null),P.size===0&&(St=!1,bt=null,tt("pinch"),A())}),window.addEventListener("resize",()=>{I(),A(),!z&&Lt()})})();function Wt(){if(!(()=>{try{return window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})()||document.getElementById("mobileQuickbar"))return;window.__synthNavLocks=window.__synthNavLocks||{zoomLocked:!1,panLocked:!1};let t=window.__synthNavLocks,e="./assets/icons/ui-sprite.svg",n=f=>`
    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false"
      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <use href="${e}#${f}"></use>
    </svg>
  `,o=document.createElement("div");o.id="mobileQuickbar",o.className="mobile-quickbar mobile-quickbar--collapsed",o.setAttribute("data-prevent-pan","true");let s=document.createElement("button");s.type="button",s.className="mobile-quickbar__tab",s.setAttribute("aria-label","Abrir acciones r\xE1pidas"),s.setAttribute("aria-expanded","false"),s.innerHTML=n("ti-menu-2");let i=document.createElement("div");i.className="mobile-quickbar__group";let r=document.createElement("button");r.type="button",r.className="mobile-quickbar__btn",r.setAttribute("aria-label","Bloquear paneo"),r.setAttribute("aria-pressed",String(!!t.panLocked)),r.innerHTML=n("ti-hand-stop");let d=document.createElement("button");d.type="button",d.className="mobile-quickbar__btn",d.setAttribute("aria-label","Bloquear zoom"),d.setAttribute("aria-pressed",String(!!t.zoomLocked)),d.innerHTML=n("ti-zoom-cancel");let a=document.createElement("button");a.type="button",a.className="mobile-quickbar__btn",a.setAttribute("aria-label","Pantalla completa"),a.setAttribute("aria-pressed",String(!!document.fullscreenElement)),a.innerHTML=n("ti-arrows-maximize");let c=["(display-mode: standalone)","(display-mode: fullscreen)"].map(f=>window.matchMedia?window.matchMedia(f):null).filter(Boolean),u=()=>{let f=c.some(z=>z.matches),_=typeof window.navigator<"u"&&"standalone"in window.navigator?window.navigator.standalone:!1;return f||!!_},p=!!(document.documentElement&&document.documentElement.requestFullscreen),m=()=>!p||u(),g=()=>{r.setAttribute("aria-pressed",String(!!t.panLocked)),d.setAttribute("aria-pressed",String(!!t.zoomLocked)),a.setAttribute("aria-pressed",String(!!document.fullscreenElement)),r.classList.toggle("is-active",!!t.panLocked),d.classList.toggle("is-active",!!t.zoomLocked),a.classList.toggle("is-active",!!document.fullscreenElement),a.hidden=m(),a.disabled=a.hidden},v=!1;function E(f){v=!!f,o.classList.toggle("mobile-quickbar--collapsed",!v),o.classList.toggle("mobile-quickbar--expanded",v),s.setAttribute("aria-expanded",String(v))}s.addEventListener("click",()=>{E(!v)}),r.addEventListener("click",()=>{t.panLocked=!t.panLocked,g()}),d.addEventListener("click",()=>{t.zoomLocked=!t.zoomLocked,g()}),a.addEventListener("click",async()=>{if(!a.disabled)try{document.fullscreenElement?await document.exitFullscreen():await document.documentElement.requestFullscreen()}catch(f){console.error("No se pudo alternar la pantalla completa.",f)}finally{g()}}),document.addEventListener("fullscreenchange",g),c.forEach(f=>f.addEventListener("change",g)),i.appendChild(r),i.appendChild(d),i.appendChild(a),o.appendChild(i),o.appendChild(s),document.body.appendChild(o),g()}window.addEventListener("DOMContentLoaded",()=>{$t(),window._synthApp=new Et,window._synthApp&&window._synthApp.ensureAudio&&window._synthApp.ensureAudio(),Dt(),Vt(),Wt()});function $t(){if(Rt||(Rt=!0,!window.matchMedia("(orientation: portrait)").matches))return;let t=document.getElementById("orientationHint");t||(t=document.createElement("div"),t.id="orientationHint",t.className="orientation-hint",document.body.appendChild(t)),t.textContent="Gira el dispositivo en posici\xF3n horizontal para una mejor experiencia de uso del sintetizador",requestAnimationFrame(()=>{t.classList.remove("hide"),t.classList.add("show")}),setTimeout(()=>Yt(),4500)}function Yt(){let h=document.getElementById("orientationHint");h&&(h.classList.add("hide"),h.classList.remove("show"),setTimeout(()=>{h.parentNode&&h.parentNode.removeChild(h)},600))}function Dt(){if(!("serviceWorker"in navigator))return;let h=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{h||(h=!0,window.location.reload())});let t=e=>{if(!e||!navigator.serviceWorker.controller)return;window.confirm("Hay una nueva versi\xF3n disponible de SynthiGME-web. \xBFQuieres recargar ahora?")&&e.postMessage({type:"SKIP_WAITING"})};navigator.serviceWorker.register("./sw.js").then(e=>{e.waiting&&t(e.waiting),e.addEventListener("updatefound",()=>{let n=e.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&t(n)})})}).catch(e=>{console.error("No se pudo registrar el service worker.",e)})}
